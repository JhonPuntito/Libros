<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Catálogo de libros</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#071024;color:#e8f6ff;margin:0}
    header{background:#051525;padding:16px}
    h1{margin:0;font-size:18px}
    .wrap{max-width:960px;margin:18px auto;padding:12px}
    label{display:block;margin-top:8px;font-size:13px}
    input[type="text"], textarea, select{width:100%;padding:8px;border-radius:6px;border:1px solid #193247;background:#062233;color:#fff}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    button{margin-top:10px;padding:10px 12px;border-radius:8px;border:none;background:#1e90ff;color:#fff;cursor:pointer}
    .books-list{margin-top:16px}
    .book-item{background:#062733;padding:10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px;opacity:.9}
    textarea#output{height:160px;font-family:monospace;margin-top:12px;width:100%}
    .hint{opacity:.8;font-size:13px;margin-top:8px}
    .actions{display:flex;gap:8px}
    .danger{background:#b03030}
    .search{margin:12px 0;display:flex;gap:8px}
    .search input{flex:1}
  </style>
</head>
<body>
  <header><h1>Panel administrador — Catálogo de libros</h1></header>
  <main class="wrap">
    <div class="hint">Gestiona tus libros. Puedes guardar directamente en GitHub usando el botón correspondiente.</div>

    <div style="margin-top:12px">
      <label>Título</label>
      <input id="titulo" type="text" placeholder="Título del libro" />
      <label>Autor</label>
      <input id="autor" type="text" placeholder="Autor" />
      <div class="row">
        <div>
          <label>Disponible</label>
          <select id="disponible"><option value="true">Sí</option><option value="false">No</option></select>
        </div>
        <div>
          <label>Notas (opcional)</label>
          <input id="notas" type="text" placeholder="Ej: edición, observaciones..." />
        </div>
      </div>
      <button id="addBtn">Añadir / Actualizar</button>
    </div>

    <div class="search">
      <input id="search" type="text" placeholder="Buscar en admin..." />
      <button id="btnSearch">Filtrar</button>
      <button id="btnReset">Reset</button>
    </div>

    <section class="books-list" id="booksList"></section>

    <div style="margin-top:14px">
      <button id="generate">Generar JSON</button>
      <button id="saveGithub" style="background:#2b8a55">Guardar en GitHub</button>
      <button id="clear" class="danger">Limpiar lista</button>
      <textarea id="output" placeholder="El JSON generado aparecerá aquí..."></textarea>
    </div>
  </main>

<script>
let books = [];
function uid(){ return Date.now() + Math.floor(Math.random()*999); }
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function render(filter=''){
  const list=document.getElementById('booksList'); list.innerHTML='';
  let filtered=books;
  if(filter) filtered=books.filter(b=>b.titulo.toLowerCase().includes(filter)||b.autor.toLowerCase().includes(filter));
  if(!filtered.length) list.innerHTML='<div class="small">Lista vacía</div>';
  filtered.forEach(b=>{
    const div=document.createElement('div'); div.className='book-item';
    const left=document.createElement('div'); left.innerHTML=`<strong>${escapeHtml(b.titulo)}</strong><div class="small">${escapeHtml(b.autor||'')}</div>`;
    const right=document.createElement('div'); right.innerHTML=`<div class="small">ID: ${b.id} · ${b.disponible?'<span style="color:#9df0b8">Disponible</span>':'<span style="color:#ffb4b4">Prestado</span>'}</div>
      <div style="margin-top:6px" class="actions">
        <button onclick="toggle(${b.id})">Toggle</button>
        <button onclick="edit(${b.id})">Editar</button>
        <button onclick="remove(${b.id})" style="background:#b03030">Eliminar</button>
      </div>`;
    div.appendChild(left); div.appendChild(right);
    list.appendChild(div);
  });
  document.getElementById('output').value=JSON.stringify(books,null,2);
}

document.getElementById('addBtn').addEventListener('click',()=>{
  const t=document.getElementById('titulo').value.trim(); if(!t){alert('El título es obligatorio');return;}
  const a=document.getElementById('autor').value.trim();
  const n=document.getElementById('notas').value.trim();
  const d=document.getElementById('disponible').value==='true';
  let existing=books.find(b=>b.titulo.toLowerCase()===t.toLowerCase());
  if(existing){ existing.autor=a; existing.notas=n; existing.disponible=d; }
  else{ books.push({id:uid(),titulo:t,autor:a,disponible:d,notas:n}); }
  document.getElementById('titulo').value='';document.getElementById('autor').value='';document.getElementById('notas').value='';
  render();
});

function toggle(id){const b=books.find(x=>x.id==id);if(b){b.disponible=!b.disponible;render();}}
function edit(id){const b=books.find(x=>x.id==id);if(!b)return;document.getElementById('titulo').value=b.titulo;document.getElementById('autor').value=b.autor||'';document.getElementById('notas').value=b.notas||'';document.getElementById('disponible').value=b.disponible?'true':'false';books=books.filter(x=>x.id!=id);render();}
function remove(id){if(!confirm('Eliminar este libro?'))return;books=books.filter(x=>x.id!=id);render();}

document.getElementById('generate').addEventListener('click',()=>{document.getElementById('output').value=JSON.stringify(books,null,2);});

document.getElementById('clear').addEventListener('click',()=>{if(confirm('¿Borrar toda la lista?')){books=[];render();}});

document.getElementById('btnSearch').addEventListener('click',()=>{const q=document.getElementById('search').value.trim().toLowerCase();render(q);});
document.getElementById('btnReset').addEventListener('click',()=>{document.getElementById('search').value='';render();});

// Guardar en GitHub vía Render
document.getElementById('saveGithub').addEventListener('click', async () => {
  const payload = { books };
  try {
    const res = await fetch("https://libros-backend.onrender.com/update-books", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.ok) {
      alert("OK ✅: " + (data.message || "Workflow disparado"));
    } else {
      alert("Error en servidor: " + JSON.stringify(data));
    }
  } catch (e) {
    alert("Error de red: " + e.message);
  }
});

// Cargar inicial
fetch('books.json',{cache:"no-store"}).then(r=>r.ok?r.json():[]).then(data=>{
  if(Array.isArray(data)&&data.length)books=data.map(b=>({id:b.id||uid(),titulo:b.titulo||'',autor:b.autor||'',disponible:!!b.disponible,notas:b.notas||''}));
  render();
}).catch(()=>render());
</script>
</body>
</html>
